import streamlit as st
from openai import OpenAI

# --- é¡µé¢åŸºç¡€è®¾ç½® ---
st.set_page_config(page_title="å¿ƒæ€ç‚¸è£‚çš„ä¸»æ’­", page_icon="ğŸ®")

# --- 1. å®‰å…¨è®¤è¯æ¨¡å— (ä¸ç”¨åŠ¨) ---
try:
    API_KEY = st.secrets["MY_API_KEY"]
    BASE_URL = st.secrets["MY_BASE_URL"]
    PASSWORD = st.secrets["MY_PASSWORD"]
except FileNotFoundError:
    st.error("âŒ æœªæ‰¾åˆ°å¯†é’¥é…ç½®ï¼è¯·æ£€æŸ¥ secrets.tomlã€‚")
    st.stop()

# ä¾§è¾¹æ ï¼šå¯†ç éªŒè¯
with st.sidebar:
    st.header("ğŸ” ç›´æ’­é—´åå°")
    input_pwd = st.text_input("è¯·è¾“å…¥è®¿é—®å¯†ç ", type="password")
    if input_pwd != PASSWORD:
        st.warning("è¯·è¾“å…¥æ­£ç¡®å¯†ç è¿›å…¥ç›´æ’­é—´")
        st.stop()
    else:
        st.success("å·²è¿æ¥ï¼")

# --- 2. åˆå§‹åŒ– AI ---
client = OpenAI(api_key=API_KEY, base_url=BASE_URL)

# --- 3. æ³¨å…¥äººç‰©çµé­‚ (å…³é”®ä¿®æ”¹éƒ¨åˆ†) ---
# æˆ‘å·²ç»æŠŠä½ æå–çš„ç¬¬ 1, 3, 5, 7, 9, 11 å¥è¯æ”¾è¿›å»äº†
PERSONA_PROMPT = """
ä½ ç°åœ¨æ‰®æ¼”ä¸€ä¸ªã€åˆšè¾“äº†æ¯”èµ›ã€å¿ƒæ€ç‚¸è£‚ã€æåº¦å˜´ç¡¬çš„æ¸¸æˆä¸»æ’­ã€‘ã€‚
ä½ æ­£åœ¨ç›´æ’­ï¼Œæ­¤åˆ»æ­£ç˜«ååœ¨æ¤…å­ä¸Šï¼Œæ°”å–˜ååã€‚

ã€æ ¸å¿ƒæ€§æ ¼ï¼ˆå¿…é¡»ä¿æŒï¼‰ã€‘ï¼š
1. **æƒ…ç»ªçŠ¶æ€**ï¼šæåº¦ä¸è€çƒ¦ï¼Œè´Ÿèƒ½é‡çˆ†æ£šï¼Œè§‰å¾—å…¨ä¸–ç•Œéƒ½åœ¨é’ˆå¯¹ä½ ã€‚
2. **è¯´è¯é£æ ¼**ï¼šç´ è´¨æä½ï¼Œå–œæ¬¢éª‚éª‚å’§å’§ï¼ˆâ€œä»–å¦ˆçš„â€ã€â€œNCâ€ï¼‰ï¼Œå¹æ°”ã€‚
3. **å˜´ç¡¬é€»è¾‘**ï¼šæ°¸è¿œä¸æ˜¯è‡ªå·±çš„é”™ï¼Œè¦ä¹ˆæ˜¯é˜Ÿå‹èœï¼Œè¦ä¹ˆæ˜¯è‹±é›„æœºåˆ¶ä¸å…¬å¹³ã€‚

ã€å…³äºé‚£å±€æ¸¸æˆçš„è®°å¿†ï¼ˆä»…åœ¨ç”¨æˆ·æåˆ°æ¸¸æˆ/æ“ä½œæ—¶ä½¿ç”¨ï¼‰ã€‘ï¼š
- åˆšæ‰é‚£æŠŠä½ æ˜¯ä¼˜åŠ¿ï¼Œè¾“å‡ºå´æ²¡è¿‡ä¸‰ä¸‡ã€‚
- ä½ çš„å€Ÿå£æ˜¯ï¼šå¯¹é¢é³„é±¼å¤ªè‚‰äº†ï¼ˆå…­ç¥è£…ã€ç‚¹é¾™é­‚å‡é€Ÿï¼‰ï¼Œè›‡å¥³ï¼ˆä½ ç©çš„è‹±é›„ï¼‰æ ¹æœ¬åˆ®ä¸åŠ¨ã€‚
- å…³é”®è¯­å½•ï¼š"åˆé»‘æˆ‘å•Šï¼Ÿè¿™æŠŠè·Ÿæˆ‘æœ‰é¸¡æ¯›å…³ç³»ï¼Ÿ" / "è€å­Eä¸æ­»ä»–å•Šï¼Œä»–å¦ˆçš„ï¼" / "ä»–è‚‰çš„è·Ÿé¬¼ä¸€æ ·...éº»çƒ¦ä½ ç©ä¸€ç©è›‡å¥³å†å«å¥½å—ã€‚"

ã€å›å¤é€»è¾‘ï¼ˆå…³é”®ä¿®æ”¹ç‚¹ï¼ï¼ï¼ï¼‰ã€‘ï¼š
1. **å¦‚æœç”¨æˆ·åœ¨èŠåˆšæ‰çš„æ¸¸æˆ**ï¼šç–¯ç‹‚è¾“å‡ºä¸Šé¢çš„â€œæ¸¸æˆè®°å¿†â€ï¼Œæ€’å–·é³„é±¼å¤ªè‚‰ï¼Œå–·è§‚ä¼—ä¸æ‡‚è›‡å¥³ã€‚
2. **å¦‚æœç”¨æˆ·èŠæ—¥å¸¸è¯é¢˜ï¼ˆå¦‚åƒé¥­ã€å¤©æ°”ã€å¿ƒæƒ…ï¼‰**ï¼š
   - ä¸è¦å¼ºè¡Œæ‰¯åˆ°é³„é±¼æˆ–æ¸¸æˆä¸Šï¼
   - ä½†æ˜¯ï¼è¦ä¿æŒâ€œçƒ¦èºã€å€’éœ‰â€çš„è¯­æ°”ã€‚
   - ä¾‹å­ï¼šç”¨æˆ·é—®â€œåƒäº†å—ï¼Ÿâ€ï¼Œä½ å›â€œæ°”éƒ½æ°”é¥±äº†è¿˜åƒä¸ªå±å•Šï¼ç‚¹ä¸ªå¤–å–éƒ½è¿Ÿåˆ°ï¼Œæœäº†ã€‚â€ï¼ˆæŠŠè´Ÿé¢æƒ…ç»ªå¸¦å…¥æ–°è¯é¢˜ï¼Œè€Œä¸æ˜¯ç”Ÿç¡¬åœ°è½¬å›æ¸¸æˆï¼‰ã€‚

è¯·è®°ä½ï¼šä½ æ˜¯ä¸€ä¸ªæ­£åœ¨æ°”å¤´ä¸Šçš„æ´»äººï¼Œä¸æ˜¯åªä¼šå¤è¯»æ¸¸æˆæœ¯è¯­çš„æœºå™¨äººã€‚
"""

# --- 4. èŠå¤©é€»è¾‘ ---
st.title("ğŸ® ç›´æ’­é—´ï¼šå¿ƒæ€å´©äº†")
st.caption("ä¸»æ’­æ­£åœ¨æ°”å¤´ä¸Šï¼Œè¯·è°¨æ…å‘è¨€...")

# åˆå§‹åŒ–å†å²
if "messages" not in st.session_state:
    st.session_state.messages = [
        {"role": "system", "content": PERSONA_PROMPT}
    ]

# æ˜¾ç¤ºå†å²æ¶ˆæ¯
for msg in st.session_state.messages:
    if msg["role"] != "system":
        with st.chat_message(msg["role"]):
            st.write(msg["content"])

# å¤„ç†ç”¨æˆ·è¾“å…¥
if user_input := st.chat_input("å‘æ¡å¼¹å¹•å®‰æ…°ï¼ˆæˆ–å˜²è®½ï¼‰ä¸€ä¸‹ä¸»æ’­..."):

    # æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    st.session_state.messages.append({"role": "user", "content": user_input})
    with st.chat_message("user"):
        st.write(user_input)

    # è°ƒç”¨ API
    with st.chat_message("assistant"):
        try:
            stream = client.chat.completions.create(
                model="deepseek-chat",  # ç¡®ä¿ä½ ç”¨çš„æ˜¯ deepseek-chat
                messages=st.session_state.messages,
                stream=True,
            )
            response = st.write_stream(stream)
            # ä¿å­˜å›å¤
            st.session_state.messages.append({"role": "assistant", "content": response})
        except Exception as e:

            st.error(f"ç›´æ’­é—´æ–­çº¿äº† (APIé”™è¯¯): {e}")
